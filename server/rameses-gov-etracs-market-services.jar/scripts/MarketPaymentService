import com.rameses.annotations.*;
import java.text.*;
import com.rameses.functions.*;
import com.rameses.util.*;
import com.rameses.rules.common.*;

class MarketPaymentService {
	
	@DataContext("market_payment")
	def pmtEm;

	@DataContext("market_payment_item")
	def pmtItemEm;

	@DataContext("market_rental_ledger")
	def ledgerEm;

	@DataContext("market_account")
	def acctEm;

	@Service("DateService")
	def dateSvc;

	def dformat = new SimpleDateFormat("yyyy-MM-dd");

	@ProxyMethod
	public def postPayment( def r ) {

		def pmt = [:];
		if(!pmt.reftype) pmt.reftype = 'cashreceipt';	
		pmt.txndate = r.txndate;	
		pmt.refid = r.objid;	
		pmt.refno = r.receiptno;	
		pmt.refdate = r.receiptdate;	
		pmt.txnmode = r.txnmode;	
		pmt.amount = r.amount;	
		pmt.voided = 0;
		pmt = pmtEm.create( pmt );

		r.entries.each { e->
			e.billitems.each {
				if(it.ledgertype == 'market_rental') {
					if( !it.refid ) {
						def ledger = [:];
						ledger.acctid = e.acctid;
						ledger.year = it.year;
						ledger.month = it.month;
						ledger.fromdate = it.fromdate;
						ledger.todate = it.todate;
						ledger.numdays = it.numdays;
						ledger.amount = it.rate;
						ledger.amtpaid = it.amount;
						ledger.rate = it.rate;
						ledger = ledgerEm.create( ledger );
						it.refid = ledger.objid;
					}
					else {
						def ledger = [:];
						ledgerEm.find( [objid: it.refid ] ).update( [todate: it.todate, amount: "{amount + :amt}"], [amt: it.amount ] );	
					}
				}
				def pmtItem = [:];
				pmtItem.parent = pmt;
				pmtItem.refid = it.refid;
				pmtItem.amount = it.amount;
				pmtItem.discount = it.discount;
				pmtItem.surcharge = it.surcharge;
				pmtItem.interest = it.interest;
				pmtItem.fromdate = it.fromdate;
				pmtItem.todate = it.todate;
				pmtItem.ledgertype = it.ledgertype;
				pmtItemEm.create( pmtItem );
			}
		}
		println "*************************";		
		throw new Exception("Posting payment");	
	}

	@ProxyMethod
	public void voidPayment( def r ) {
		r.each { k,v->
			println k;
		}	
		throw new Exception("Voiding payment");	
	}


}